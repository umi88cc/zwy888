<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>后台管理 - 优米博客</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #f0f2f5; color: #333; }
        .admin-layout { display: flex; min-height: 100vh; }
        
        /* 侧边栏 */
        .sidebar { width: 240px; background: #001529; color: #fff; display: flex; flex-direction: column; }
        .sidebar-header { height: 60px; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; background: #002140; }
        .nav-menu { flex: 1; padding-top: 20px; }
        .nav-item { padding: 15px 25px; cursor: pointer; color: #a6adb4; display: flex; align-items: center; transition: 0.3s; }
        .nav-item:hover, .nav-item.active { background: #1890ff; color: #fff; }
        .nav-item i { margin-right: 10px; width: 20px; text-align: center; }
        
        /* 主内容 */
        .main-content { flex: 1; padding: 20px; overflow-y: auto; }
        .panel { display: none; background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .panel.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        h2 { margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; }

        /* 表单与表格 */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #d9d9d9; border-radius: 4px; }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; color: #fff; font-size: 14px; }
        .btn-primary { background: #1890ff; }
        .btn-danger { background: #ff4d4f; }
        .btn-success { background: #52c41a; }
        .btn-warn { background: #faad14; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px 10px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        th { background: #fafafa; }
        
        /* Tab切换 (文章/回收站) */
        .sub-tabs { margin-bottom: 15px; }
        .sub-tab { display: inline-block; padding: 5px 15px; cursor: pointer; border-bottom: 2px solid transparent; }
        .sub-tab.active { color: #1890ff; border-bottom-color: #1890ff; font-weight: bold; }
    </style>
</head>
<body>

<div class="admin-layout">
    <aside class="sidebar">
        <div class="sidebar-header">UMI Admin</div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="switchPanel('setting')"><i class="fa-solid fa-sliders"></i> 基础设置</div>
            <div class="nav-item" onclick="switchPanel('user')"><i class="fa-solid fa-users"></i> 用户管理</div>
            <div class="nav-item" onclick="switchPanel('post')"><i class="fa-solid fa-file-pen"></i> 文章管理</div>
            <div class="nav-item" onclick="switchPanel('comment')"><i class="fa-solid fa-comments"></i> 评论管理</div>
            <div class="nav-item" onclick="switchPanel('category')"><i class="fa-solid fa-tags"></i> 分类管理</div>
        </div>
        <div class="nav-item" onclick="location.href='/'"><i class="fa-solid fa-arrow-right-from-bracket"></i> 返回前台</div>
    </aside>

    <main class="main-content">

        <div id="panel-setting" class="panel active">
            <h2>基础设置</h2>
            <form id="settingForm">
                <div class="form-group">
                    <label>网站名称</label>
                    <input type="text" name="siteName" class="form-control" placeholder="例如：优米博客">
                </div>
                
                <div class="form-group">
                    <label>插入配置 (短代码/广告HTML)</label>
                    <textarea name="insertConfig" class="form-control" style="height:100px;" placeholder="可在文章中插入的通用代码"></textarea>
                </div>

                <h3>支付配置 (支付宝当面付)</h3>
                <div class="form-group">
                    <label>App ID</label>
                    <input type="text" name="alipayAppId" class="form-control">
                </div>
                <div class="form-group">
                    <label>支付宝公钥</label>
                    <textarea name="alipayPublicKey" class="form-control" style="height:80px;"></textarea>
                </div>
                <div class="form-group">
                    <label>应用私钥</label>
                    <textarea name="alipayPrivateKey" class="form-control" style="height:80px;"></textarea>
                </div>

                <h3>菜单设置 (JSON)</h3>
                <div class="form-group">
                    <textarea name="menuJson" class="form-control" style="height:150px; font-family:monospace;">[]</textarea>
                </div>
                
                <button type="submit" class="btn btn-primary">保存所有设置</button>
            </form>
        </div>

        <div id="panel-user" class="panel">
            <div style="display:flex; justify-content:space-between;">
                <h2>用户列表</h2>
                <button class="btn btn-success" onclick="showAddUserModal()">+ 新增用户</button>
            </div>
            <table>
                <thead><tr><th>ID</th><th>账号</th><th>QQ/头像</th><th>角色</th><th>VIP等级</th><th>状态</th><th>操作</th></tr></thead>
                <tbody id="userTable"></tbody>
            </table>
            
            <div id="addUserBox" style="display:none; margin-top:20px; border:1px solid #ddd; padding:20px;">
                <h3>新增用户</h3>
                <input type="text" id="newUsername" placeholder="用户名" class="form-control" style="margin-bottom:10px;">
                <input type="text" id="newPassword" placeholder="密码" class="form-control" style="margin-bottom:10px;">
                <select id="newRole" class="form-control" style="margin-bottom:10px;">
                    <option value="user">普通用户</option>
                    <option value="admin">管理员</option>
                </select>
                <button class="btn btn-primary" onclick="addUser()">确认添加</button>
                <button class="btn btn-danger" onclick="document.getElementById('addUserBox').style.display='none'">取消</button>
            </div>
        </div>

        <div id="panel-post" class="panel">
            <div class="sub-tabs">
                <span class="sub-tab active" onclick="loadPosts('published')">已发布</span>
                <span class="sub-tab" onclick="loadPosts('trash')">回收站</span>
            </div>
            <div style="margin-bottom:15px;">
                <button class="btn btn-primary" onclick="showEditor()">+ 发布文章</button>
            </div>
            
            <div id="postListView">
                <table>
                    <thead><tr><th>ID</th><th>标题</th><th>价格</th><th>状态</th><th>操作</th></tr></thead>
                    <tbody id="postTable"></tbody>
                </table>
            </div>

            <div id="postEditor" style="display:none;">
                <h3>编辑/发布文章</h3>
                <form id="postForm">
                    <input type="hidden" name="id">
                    <div class="form-group"><label>标题</label><input type="text" name="title" class="form-control" required></div>
                    <div class="form-group"><label>别名(Slug)</label><input type="text" name="slug" class="form-control" required></div>
                    <div style="display:flex; gap:10px;">
                        <div class="form-group" style="flex:1;"><label>价格</label><input type="number" name="price" class="form-control" value="0"></div>
                        <div class="form-group" style="flex:1;"><label>分类ID</label><input type="number" name="category_id" class="form-control"></div>
                        <div class="form-group" style="flex:1;"><label>权限</label>
                            <select name="view_permission" class="form-control">
                                <option value="0">全员</option><option value="1">VIP</option><option value="2">SVIP</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group"><label>内容</label><textarea name="content" class="form-control" style="height:300px;" required></textarea></div>
                    <button type="submit" class="btn btn-primary">保存</button>
                    <button type="button" class="btn btn-danger" onclick="hideEditor()">取消</button>
                </form>
            </div>
        </div>

        <div id="panel-comment" class="panel">
            <h2>评论管理</h2>
            <table>
                <thead><tr><th>用户</th><th>文章</th><th>内容</th><th>时间</th><th>操作</th></tr></thead>
                <tbody id="commentTable"></tbody>
            </table>
        </div>

        <div id="panel-category" class="panel">
            <h2>文章分类</h2>
            <div style="margin-bottom:10px;">
                <input type="text" id="catName" placeholder="名称" style="padding:5px;">
                <input type="text" id="catSlug" placeholder="别名" style="padding:5px;">
                <input type="text" id="catIcon" placeholder="图标Class" style="padding:5px;">
                <button class="btn btn-success" onclick="addCategory()">添加</button>
            </div>
            <table>
                <thead><tr><th>ID</th><th>名称</th><th>别名</th><th>图标</th><th>操作</th></tr></thead>
                <tbody id="catTable"></tbody>
            </table>
        </div>

    </main>
</div>

<script>
    const API = '/api/admin';
    const token = localStorage.getItem('umi_token');
    
    // 初始化
    if(!token) location.href='/';
    switchPanel('setting'); // 默认页
    
    // 切换面板
    function switchPanel(name) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('panel-'+name).classList.add('active');
        // 高亮菜单略
        
        if(name === 'setting') loadSettings();
        if(name === 'user') loadUsers();
        if(name === 'post') loadPosts('published');
        if(name === 'comment') loadComments();
        if(name === 'category') loadCategories();
    }

    // --- 1. 设置逻辑 ---
    async function loadSettings() {
        const res = await fetch(API + '/settings', { headers: {'Authorization': `Bearer ${token}`} });
        const json = await res.json();
        if(json.data) {
            const f = document.getElementById('settingForm');
            f.siteName.value = json.data.siteName || '';
            f.insertConfig.value = json.data.insertConfig || '';
            f.alipayAppId.value = json.data.alipayAppId || '';
            f.menuJson.value = json.data.menuJson || '[]';
        }
    }
    document.getElementById('settingForm').onsubmit = async (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        await fetch(API + '/settings/save', {
            method:'POST', headers:{'Authorization':`Bearer ${token}`, 'Content-Type':'application/json'},
            body: JSON.stringify(data)
        });
        alert('设置已保存');
    };

    // --- 2. 用户逻辑 ---
    async function loadUsers() {
        const res = await fetch(API + '/users', { headers: {'Authorization': `Bearer ${token}`} });
        const json = await res.json();
        document.getElementById('userTable').innerHTML = json.data.map(u => `
            <tr>
                <td>${u.id}</td>
                <td><input value="${u.username}" style="width:80px;"></td>
                <td><img src="http://q.qlogo.cn/headimg_dl?dst_uin=${u.qq_number}&spec=100" width="30"></td>
                <td>
                    <select onchange="updateUser(${u.id}, 'role', this.value)">
                        <option value="user" ${u.role==='user'?'selected':''}>用户</option>
                        <option value="admin" ${u.role==='admin'?'selected':''}>管理员</option>
                    </select>
                </td>
                <td>
                    <select onchange="updateUser(${u.id}, 'vip_level', this.value)">
                        <option value="0" ${u.vip_level===0?'selected':''}>无</option>
                        <option value="1" ${u.vip_level===1?'selected':''}>VIP</option>
                        <option value="2" ${u.vip_level===2?'selected':''}>SVIP</option>
                    </select>
                </td>
                <td>${u.is_banned ? '<span style="color:red">黑屋</span>' : '正常'}</td>
                <td>
                    <button class="btn btn-sm btn-warn" onclick="updateUser(${u.id}, 'is_banned', ${u.is_banned?0:1})">${u.is_banned?'释放':'封禁'}</button>
                </td>
            </tr>
        `).join('');
    }
    
    async function updateUser(id, field, value) {
        await fetch(API + '/users/edit', {
            method:'POST', headers:{'Authorization':`Bearer ${token}`, 'Content-Type':'application/json'},
            body: JSON.stringify({id, [field]: value})
        });
        alert('已更新'); loadUsers();
    }
    
    function showAddUserModal() { document.getElementById('addUserBox').style.display='block'; }
    async function addUser() {
        const u = document.getElementById('newUsername').value;
        const p = document.getElementById('newPassword').value;
        const r = document.getElementById('newRole').value;
        await fetch(API + '/users/add', {
            method:'POST', headers:{'Authorization':`Bearer ${token}`, 'Content-Type':'application/json'},
            body: JSON.stringify({username:u, password:p, role:r})
        });
        alert('添加成功'); loadUsers(); document.getElementById('addUserBox').style.display='none';
    }

    // --- 3. 文章逻辑 ---
    let currentPostStatus = 'published';
    async function loadPosts(status) {
        currentPostStatus = status;
        const res = await fetch(API + `/posts?status=${status}`, { headers: {'Authorization': `Bearer ${token}`} });
        const json = await res.json();
        
        document.getElementById('postTable').innerHTML = json.data.map(p => `
            <tr>
                <td>${p.id}</td>
                <td>${p.title}</td>
                <td>${p.price}</td>
                <td>${status}</td>
                <td>
                    ${status === 'published' ? 
                      `<button class="btn btn-primary" onclick='editPost(${JSON.stringify(p)})'>编辑</button>
                       <button class="btn btn-warn" onclick="setPostStatus(${p.id}, 'trash')">回收站</button>` 
                      : 
                      `<button class="btn btn-success" onclick="setPostStatus(${p.id}, 'restore')">还原</button>
                       <button class="btn btn-danger" onclick="setPostStatus(${p.id}, 'delete')">彻底删除</button>`
                    }
                </td>
            </tr>
        `).join('');
        
        document.getElementById('postListView').style.display = 'block';
        document.getElementById('postEditor').style.display = 'none';
    }
    
    async function setPostStatus(id, action) {
        if(action==='delete' && !confirm('不可恢复，确定吗？')) return;
        await fetch(API + '/posts/status', {
            method:'POST', headers:{'Authorization':`Bearer ${token}`, 'Content-Type':'application/json'},
            body: JSON.stringify({id, action})
        });
        loadPosts(currentPostStatus);
    }
    
    function showEditor() { document.getElementById('postListView').style.display='none'; document.getElementById('postEditor').style.display='block'; }
    function hideEditor() { document.getElementById('postListView').style.display='block'; document.getElementById('postEditor').style.display='none'; }
    
    document.getElementById('postForm').onsubmit = async (e) => {
        e.preventDefault();
        const data = Object.fromEntries(new FormData(e.target));
        await fetch(API + '/posts/save', {
            method:'POST', headers:{'Authorization':`Bearer ${token}`, 'Content-Type':'application/json'},
            body: JSON.stringify(data)
        });
        alert('保存成功'); hideEditor(); loadPosts('published');
    };
    function editPost(p) {
        showEditor();
        const f = document.getElementById('postForm');
        f.id.value=p.id; f.title.value=p.title; f.slug.value=p.slug; 
        f.price.value=p.price; f.content.value=p.content; f.category_id.value=p.category_id;
    }

    // --- 4. 评论/分类 (简略) ---
    async function loadComments() {
        const res = await fetch(API + '/comments', { headers: {'Authorization': `Bearer ${token}`} });
        const json = await res.json();
        document.getElementById('commentTable').innerHTML = json.data.map(c => `
            <tr><td>${c.username}</td><td>${c.title}</td><td>${c.content}</td><td>${c.created_at}</td><td><button class="btn btn-danger" onclick="delComment(${c.id})">删除</button></td></tr>
        `).join('');
    }
    async function delComment(id) {
        await fetch(API + '/comments/delete', { method:'POST', headers:{'Authorization':`Bearer ${token}`, 'Content-Type':'application/json'}, body: JSON.stringify({id}) });
        loadComments();
    }
    
    async function loadCategories() {
        const res = await fetch(API + '/categories', { headers: {'Authorization': `Bearer ${token}`} });
        const json = await res.json();
        document.getElementById('catTable').innerHTML = json.data.map(c => `
            <tr><td>${c.id}</td><td>${c.name}</td><td>${c.slug}</td><td><i class="fa ${c.icon}"></i></td><td><button class="btn btn-danger" onclick="delCat(${c.id})">删除</button></td></tr>
        `).join('');
    }
    async function addCategory() {
        const name=document.getElementById('catName').value;
        const slug=document.getElementById('catSlug').value;
        const icon=document.getElementById('catIcon').value;
        await fetch(API + '/categories/save', { method:'POST', headers:{'Authorization':`Bearer ${token}`, 'Content-Type':'application/json'}, body: JSON.stringify({name, slug, icon}) });
        loadCategories();
    }
    async function delCat(id) {
        await fetch(API + '/categories/delete', { method:'POST', headers:{'Authorization':`Bearer ${token}`, 'Content-Type':'application/json'}, body: JSON.stringify({id}) });
        loadCategories();
    }
</script>
</body>
</html>
