<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>优米博客 - 后台管理</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #f0f2f5; }
        .admin-container { display: flex; max-width: 1200px; margin: 20px auto; gap: 20px; }
        
        /* 左侧菜单 */
        .sidebar { width: 250px; background: #fff; padding: 20px; border-radius: 12px; height: fit-content; }
        .sidebar h3 { margin-bottom: 20px; text-align: center; color: #333; }
        .nav-item { display: block; padding: 12px 15px; color: #666; margin-bottom: 5px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .nav-item:hover, .nav-item.active { background: #e6f7ff; color: #1890ff; }
        .nav-item i { margin-right: 10px; width: 20px; text-align: center; }

        /* 右侧内容 */
        .content-area { flex: 1; background: #fff; padding: 30px; border-radius: 12px; min-height: 600px; }
        .panel { display: none; }
        .panel.active { display: block; }
        
        /* 表格样式 */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #fafafa; color: #666; }
        .btn-sm { padding: 5px 10px; font-size: 12px; border-radius: 4px; border: none; cursor: pointer; margin-right: 5px; }
        .btn-danger { background: #ff4d4f; color: #fff; }
        .btn-primary { background: #1890ff; color: #fff; }
        
        /* 表单样式 */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .form-group textarea { height: 300px; font-family: monospace; }
        
        .status-badge { padding: 2px 6px; border-radius: 4px; font-size: 12px; }
        .status-normal { background: #e6fffb; color: #13c2c2; }
        .status-banned { background: #fff1f0; color: #cf1322; }
    </style>
</head>
<body>

    <header class="navbar">
        <a href="/" class="logo">
            <span>优米博客后台</span>
        </a>
        <div class="user-action"><a href="/" style="font-size:14px">返回前台</a></div>
    </header>

    <div class="admin-container">
        <aside class="sidebar">
            <h3>管理菜单</h3>
            <div class="nav-item active" onclick="showPanel('post')"><i class="fa-solid fa-pen-nib"></i> 文章管理</div>
            <div class="nav-item" onclick="showPanel('user')"><i class="fa-solid fa-users"></i> 用户管理</div>
            <div class="nav-item" onclick="showPanel('setting')"><i class="fa-solid fa-gear"></i> 基础设置</div>
        </aside>

        <main class="content-area">
            
            <div id="panel-post" class="panel active">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>文章列表</h2>
                    <button class="btn-primary" style="padding:10px 20px;" onclick="showEditor()">+ 发布新文章</button>
                </div>
                
                <div id="postList">
                    <table>
                        <thead><tr><th>ID</th><th>标题</th><th>价格</th><th>权限</th><th>操作</th></tr></thead>
                        <tbody id="postTableBody"></tbody>
                    </table>
                </div>

                <div id="postEditor" style="display:none; margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
                    <h3>发布/编辑文章</h3>
                    <form id="postForm">
                        <input type="hidden" name="id" id="editId">
                        <div class="form-group">
                            <label>文章标题</label>
                            <input type="text" name="title" required>
                        </div>
                        <div class="form-group">
                            <label>URL别名 (例如 tech)</label>
                            <input type="text" name="slug" placeholder="分类别名，用于URL" required>
                        </div>
                        <div class="form-group">
                            <label>价格 (0为免费)</label>
                            <input type="number" name="price" value="0">
                        </div>
                        <div class="form-group">
                            <label>阅读权限</label>
                            <select name="view_permission">
                                <option value="0">全员可见</option>
                                <option value="1">VIP可见</option>
                                <option value="2">SVIP可见</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>文章内容 (支持HTML和短代码 [vip]...[/vip], [pay]...[/pay])</label>
                            <textarea name="content" required></textarea>
                        </div>
                        <button type="submit" class="btn-primary" style="width:100%; padding:15px;">保存发布</button>
                        <button type="button" onclick="hideEditor()" style="margin-top:10px; width:100%; padding:10px; background:#eee; border:none; border-radius:6px;">取消</button>
                    </form>
                </div>
            </div>

            <div id="panel-user" class="panel">
                <h2>用户管理 (含小黑屋)</h2>
                <table>
                    <thead><tr><th>ID</th><th>账号</th><th>身份</th><th>VIP</th><th>状态</th><th>操作</th></tr></thead>
                    <tbody id="userTableBody"></tbody>
                </table>
            </div>

            <div id="panel-setting" class="panel">
                <h2>基础设置</h2>
                <div class="form-group">
                    <label>菜单配置 (JSON格式)</label>
                    <textarea id="menuJsonConfig" style="height:200px;">
[
  {"name": "首页", "link": "/", "icon": "fa-house", "color": "#ff6b6b"},
  {"name": "会员", "link": "/vip", "icon": "fa-gem", "color": "#54a0ff"}
]
                    </textarea>
                </div>
                <button class="btn-primary" style="padding:10px 20px;" onclick="saveSettings()">保存配置</button>
            </div>

        </main>
    </div>

    <script>
        const API_BASE = 'https://umi88.cc/api/admin';
        const token = localStorage.getItem('umi_token');

        // 0. 初始化检查
        async function init() {
            if(!token) return location.href = '/';
            // 简单请求一次验证权限
            loadPosts();
        }

        function showPanel(id) {
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('panel-'+id).classList.add('active');
            
            // 高亮对应菜单
            // (略: 简单实现)
            
            if(id === 'user') loadUsers();
            if(id === 'post') loadPosts();
        }

        // --- 文章逻辑 ---
        async function loadPosts() {
            const res = await fetch(`${API_BASE}/posts`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            if(!data.success) return alert('无权访问或Token过期');
            
            const tbody = document.getElementById('postTableBody');
            tbody.innerHTML = data.data.map(p => `
                <tr>
                    <td>${p.id}</td>
                    <td>${p.title}</td>
                    <td>${p.price}</td>
                    <td>${p.view_permission}</td>
                    <td>
                        <button class="btn-sm btn-primary" onclick='editPost(${JSON.stringify(p)})'>编辑</button>
                        <button class="btn-sm btn-danger" onclick="deletePost(${p.id})">删除</button>
                    </td>
                </tr>
            `).join('');
        }

        function showEditor() { document.getElementById('postEditor').style.display = 'block'; document.getElementById('postList').style.display = 'none'; }
        function hideEditor() { document.getElementById('postEditor').style.display = 'none'; document.getElementById('postList').style.display = 'block'; }

        // 提交文章
        document.getElementById('postForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const json = Object.fromEntries(formData.entries());
            
            const res = await fetch(`${API_BASE}/posts/save`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(json)
            });
            const data = await res.json();
            alert(data.message);
            if(data.success) { hideEditor(); loadPosts(); }
        });

        // --- 用户逻辑 ---
        async function loadUsers() {
            const res = await fetch(`${API_BASE}/users`, { headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = data.data.map(u => `
                <tr>
                    <td>${u.id}</td>
                    <td>${u.username}</td>
                    <td>${u.role}</td>
                    <td>${u.vip_level}</td>
                    <td>
                        <span class="status-badge ${u.is_banned ? 'status-banned' : 'status-normal'}">
                            ${u.is_banned ? '小黑屋' : '正常'}
                        </span>
                    </td>
                    <td>
                        <button class="btn-sm btn-danger" onclick="banUser(${u.id}, ${u.is_banned ? 0 : 1})">
                            ${u.is_banned ? '释放' : '关黑屋'}
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function banUser(uid, action) {
            if(!confirm('确定要执行此操作吗？')) return;
            const res = await fetch(`${API_BASE}/users/ban`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: uid, isBanned: action })
            });
            const data = await res.json();
            alert(data.message);
            loadUsers();
        }

        // 启动
        init();
    </script>
</body>
</html>
